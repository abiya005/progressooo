<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Progresso - Student Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://kit.fontawesome.com/6c52c5d47f.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"/>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            display: flex;
            min-height: 100vh;
            background-color: #ebd8d0;
        }

        .sidebar {
            width: 250px;
            background-color: #582c4d;
            color: white;
            padding: 20px 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            position: fixed;
        }

        .logo {
            font-size: 24px;
            font-weight: bold;
            padding: 0 20px 20px;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .logo span {
            color: #ebd8d0;
        }

        .nav-menu {
            flex: 1;
            padding: 20px 0;
        }

        .nav-item {
            padding: 12px 20px;
            display: flex;
            align-items: center;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .nav-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .nav-item i {
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }

        .nav-item.active {
            background-color: #ebd8d0;
            color: #582c4d;
        }

        .user-profile {
            padding: 20px;
            display: flex;
            align-items: center;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .user-profile img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 10px;
            background-color: #fff;
            object-fit: cover;
        }

        .user-info h4 {
            font-size: 14px;
            margin-bottom: 2px;
        }

        .user-info p {
            font-size: 12px;
            opacity: 0.8;
        }

        .main-content {
            flex: 1;
            margin-left: 250px;
            padding: 20px;
        }

        .header {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
        }

        .search-bar {
            flex: 1;
            max-width: 500px;
            position: relative;
        }

        .search-bar input {
            width: 100%;
            padding: 10px 15px 10px 40px;
            border-radius: 20px;
            border: 1px solid #ddd;
            outline: none;
            font-size: 14px;
        }

        .search-bar i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #777;
        }

        .page-title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 20px;
        }

        .dashboard-cards {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background-color: #f2cfcf;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .card-title {
            font-size: 14px;
            color: #777;
            margin-bottom: 10px;
        }

        .card-value {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .card-status {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-pending {
            background-color: #ebf5ff;
            color: #3498db;
        }

        .status-completed {
            background-color: #e6f7ee;
            color: #2ecc71;
        }

        .status-in-progress {
            background-color: #fff4e5;
            color: #ffa726;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        .project-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .project-card {
            background: #f2cfcf;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 20px;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .project-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        }

        .project-card h3 {
            font-size: 18px;
            margin-bottom: 10px;
            color: #582c4d;
        }

        .progress-container {
            width: 100%;
            background-color: #e0e0e0;
            border-radius: 20px;
            margin: 10px 0;
        }

        .progress-bar {
            height: 10px;
            border-radius: 20px;
            background-color: #582c4d;
            transition: width 0.5s ease;
        }

        .progress-text {
            font-size: 14px;
            margin-top: 5px;
            color: #582c4d;
            font-weight: bold;
        }

        .subtask-list {
            margin-top: 15px;
        }

        .subtask-item {
            background: white;
            padding: 10px;
            margin: 5px 0;
            border-radius: 6px;
            border-left: 4px solid #582c4d;
        }

        .subtask-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .subtask-title {
            font-weight: bold;
            color: #582c4d;
        }

        .subtask-marks {
            background: #582c4d;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
        }

        .subtask-description {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }

        .subtask-feedback {
            font-size: 11px;
            color: #888;
            font-style: italic;
        }

        .btn-add-subtask {
            background: #582c4d;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 10px;
            transition: background 0.3s ease;
        }

        .btn-add-subtask:hover {
            background: #3a1830;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: #f2cfcf;
            margin: 15% auto;
            padding: 20px;
            border-radius: 10px;
            width: 80%;
            max-width: 500px;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #000;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #582c4d;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 14px;
        }

        .btn-submit {
            background: #582c4d;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }

        .btn-submit:hover {
            background: #3a1830;
        }

        .evaluation-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 16px;
            background: #f2cfcf;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }

        .evaluation-table th, .evaluation-table td {
            border: 1px solid #c4bdbd;
            padding: 12px 15px;
            text-align: left;
        }

        .evaluation-table th {
            background-color: #582c4d;
            color: white;
        }

        .no-data {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 40px;
        }
    </style>
</head>
<body>
    <aside class="sidebar">
        <div class="logo">PROGRESSO<span>!</span></div>
        <div class="nav-menu">
            <div class="nav-item active" data-page="dashboardPage">
                <i class="fas fa-tachometer-alt"></i>
                <span>Dashboard</span>
            </div>
            <div class="nav-item" data-page="projectsPage">
                <i class="fas fa-project-diagram"></i>
                <span>My Projects</span>
            </div>
            <div class="nav-item" data-page="subtasksPage">
                <i class="fas fa-tasks"></i>
                <span>Subtasks</span>
            </div>
            <div class="nav-item" data-page="evaluationPage">
                <i class="fas fa-clipboard-check"></i>
                <span>Evaluations</span>
            </div>
            <div class="nav-item" data-page="progressTrackingPage">
                <i class="fas fa-chart-line"></i>
                <span>Progress Tracking</span>
            </div>
            <div class="nav-item" data-page="logout" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i>
                <span>Logout</span>
            </div>
        </div>

        <div class="user-profile">
            <img src="abiya.JPG" alt="User" id="userAvatar">
            <div class="user-info">
                <h4 id="userName">Loading...</h4>
                <p id="userRole">Student</p>
            </div>
        </div>
    </aside>

    <main class="main-content">
        <div class="header">
            <div class="search-bar">
                <i class="fas fa-search"></i>
                <input type="text" placeholder="Search for anything" id="searchInput">
            </div>
        </div>

        <!-- Dashboard Page -->
        <div id="dashboardPage" class="page active">
            <h1 class="page-title">Student Dashboard</h1>
            <div class="dashboard-cards">
                <div class="card">
                    <div class="card-title">Total Projects</div>
                    <div class="card-value" id="totalProjects">0</div>
                </div>
                <div class="card">
                    <div class="card-title">Active Projects</div>
                    <div class="card-value" id="activeProjects">0</div>
                </div>
                <div class="card">
                    <div class="card-title">Completed Subtasks</div>
                    <div class="card-value" id="completedSubtasks">0</div>
                </div>
                <div class="card">
                    <div class="card-title">Average Score</div>
                    <div class="card-value" id="averageScore">0%</div>
                </div>
            </div>

            <div class="project-grid" id="dashboardProjects">
                <!-- Projects will be loaded here -->
            </div>
        </div>

        <!-- Projects Page -->
        <div id="projectsPage" class="page">
            <h1 class="page-title">My Projects</h1>
            <div class="project-grid" id="projectsList">
                <!-- Projects will be loaded here -->
            </div>
        </div>

        <!-- Subtasks Page -->
        <div id="subtasksPage" class="page">
            <h1 class="page-title">My Subtasks</h1>
            <div class="project-grid" id="subtasksList">
                <!-- Subtasks will be loaded here -->
            </div>
        </div>

        <!-- Evaluation Page -->
        <div id="evaluationPage" class="page">
            <h1 class="page-title">My Evaluations</h1>
            <table class="evaluation-table" id="evaluationTable">
                <thead>
                    <tr>
                        <th>Project</th>
                        <th>Subtask</th>
                        <th>Marks</th>
                        <th>Status</th>
                        <th>Feedback</th>
                    </tr>
                </thead>
                <tbody id="evaluationTableBody">
                    <!-- Evaluations will be loaded here -->
                </tbody>
            </table>
        </div>

        <!-- Progress Tracking Page -->
        <div id="progressTrackingPage" class="page">
            <h1 class="page-title">Progress Tracking</h1>
            
            <!-- Overall Progress Summary -->
            <div class="dashboard-cards">
                <div class="card">
                    <div class="card-title">Total Projects</div>
                    <div class="card-value" id="progressTotalProjects">0</div>
                </div>
                <div class="card">
                    <div class="card-title">Completed Projects</div>
                    <div class="card-value" id="progressCompletedProjects">0</div>
                </div>
                <div class="card">
                    <div class="card-title">Overall Progress</div>
                    <div class="card-value" id="progressOverallPercentage">0%</div>
                </div>
                <div class="card">
                    <div class="card-title">Average Score</div>
                    <div class="card-value" id="progressAverageScore">0/10</div>
                </div>
            </div>

            <!-- Detailed Progress by Project -->
            <div class="project-grid" id="progressTrackingProjects">
                <!-- Progress cards will be loaded here -->
            </div>
        </div>
    </main>

    <!-- Add Subtask Modal -->
    <div id="addSubtaskModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add New Subtask</h3>
                <span class="close">&times;</span>
            </div>
            <form id="addSubtaskForm">
                <div class="form-group">
                    <label for="subtaskProject">Project:</label>
                    <select id="subtaskProject" required>
                        <option value="">Select a project</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="subtaskTitle">Title:</label>
                    <input type="text" id="subtaskTitle" required>
                </div>
                <div class="form-group">
                    <label for="subtaskDescription">Description:</label>
                    <textarea id="subtaskDescription" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label for="subtaskDueDate">Due Date:</label>
                    <input type="date" id="subtaskDueDate" required>
                </div>
                <button type="submit" class="btn-submit">Add Subtask</button>
            </form>
        </div>
    </div>

    <script>
        // Global variables
        let currentUser = null;
        let projects = [];
        let subtasks = [];

        // Initialize the dashboard
        document.addEventListener('DOMContentLoaded', function() {
            // Check if user is logged in
            const userData = localStorage.getItem('user');
            if (!userData) {
                window.location.href = 'auth.html';
                return;
            }

            currentUser = JSON.parse(userData);
            updateUserInfo();
            
            // Show loading state
            showLoadingState();
            
            loadDashboardData();
            setupEventListeners();
        });

        function showLoadingState() {
            document.getElementById('dashboardProjects').innerHTML = `
                <div class="no-data" style="grid-column: 1 / -1; text-align: center; padding: 40px;">
                    <div style="font-size: 24px; margin-bottom: 20px;">⏳</div>
                    <h3>Loading Your Projects...</h3>
                    <p>Please wait while we fetch your data from the server.</p>
                </div>
            `;
        }

        function updateUserInfo() {
            document.getElementById('userName').textContent = currentUser.username;
            document.getElementById('userRole').textContent = currentUser.role;
        }

        async function loadDashboardData() {
            try {
                console.log('Loading dashboard data for user:', currentUser.id);
                
                // Load projects
                const projectsResponse = await fetch(`/api/student/${currentUser.id}/projects`);
                if (!projectsResponse.ok) {
                    throw new Error(`Failed to fetch projects: ${projectsResponse.status}`);
                }
                projects = await projectsResponse.json();
                console.log('Loaded projects:', projects);
                
                // Load all subtasks for all projects
                const allSubtasks = [];
                for (const project of projects) {
                    try {
                        const subtasksResponse = await fetch(`/api/project/${project.id}/subtasks`);
                        if (subtasksResponse.ok) {
                            const projectSubtasks = await subtasksResponse.json();
                            allSubtasks.push(...projectSubtasks.map(st => ({...st, project_title: project.title})));
                        }
                    } catch (error) {
                        console.error(`Error loading subtasks for project ${project.id}:`, error);
                    }
                }
                subtasks = allSubtasks;
                console.log('Loaded subtasks:', subtasks);

                updateDashboard();
                updateProjectsPage();
                updateSubtasksPage();
                updateEvaluationPage();
                updateProgressTrackingPage();
            } catch (error) {
                console.error('Error loading dashboard data:', error);
                // Show error message to user
                document.getElementById('dashboardProjects').innerHTML = `
                    <div class="no-data" style="grid-column: 1 / -1; text-align: center; padding: 40px;">
                        <h3>Error Loading Data</h3>
                        <p>Unable to load your projects and progress. Please try refreshing the page.</p>
                        <button onclick="loadDashboardData()" class="btn-submit" style="margin-top: 10px;">Retry</button>
                    </div>
                `;
            }
        }

        function updateDashboard() {
            console.log('Updating dashboard with projects:', projects.length, 'subtasks:', subtasks.length);
            
            // Update dashboard cards
            document.getElementById('totalProjects').textContent = projects.length;
            document.getElementById('activeProjects').textContent = projects.filter(p => p.status === 'active').length;
            document.getElementById('completedSubtasks').textContent = subtasks.filter(s => s.status === 'completed').length;
            
            const evaluatedSubtasks = subtasks.filter(s => s.marks !== null);
            const averageScore = evaluatedSubtasks.length > 0 
                ? Math.round(evaluatedSubtasks.reduce((sum, s) => sum + (s.marks || 0), 0) / evaluatedSubtasks.length)
                : 0;
            document.getElementById('averageScore').textContent = averageScore + '/10';

            // Update dashboard projects
            const dashboardProjects = document.getElementById('dashboardProjects');
            dashboardProjects.innerHTML = '';

            if (projects.length === 0) {
                dashboardProjects.innerHTML = `
                    <div class="no-data" style="grid-column: 1 / -1; text-align: center; padding: 40px;">
                        <h3>No Projects Assigned</h3>
                        <p>You don't have any projects assigned yet. Contact your faculty to get started!</p>
                    </div>
                `;
                return;
            }

            projects.forEach(project => {
                const projectSubtasks = subtasks.filter(s => s.project_id === project.id);
                const completedSubtasks = projectSubtasks.filter(s => s.status === 'completed').length;
                const progress = projectSubtasks.length > 0 ? (completedSubtasks / projectSubtasks.length) * 100 : 0;

                // Calculate project average score
                const projectMarks = projectSubtasks.filter(s => s.marks !== null);
                const projectAverageScore = projectMarks.length > 0 ? 
                    Math.round((projectMarks.reduce((sum, s) => sum + s.marks, 0) / projectMarks.length) * 10) / 10 : 0;

                const projectCard = document.createElement('div');
                projectCard.className = 'project-card';
                projectCard.innerHTML = `
                    <h3>${project.title}</h3>
                    <div style="margin: 10px 0; font-size: 12px; color: #666;">
                        <strong>Status:</strong> ${project.status} | 
                        <strong>Due:</strong> ${project.due_date || 'Not set'} | 
                        <strong>Score:</strong> ${projectAverageScore}/10
                    </div>
                    <div class="progress-container">
                        <div class="progress-bar" style="width: ${progress}%"></div>
                    </div>
                    <div class="progress-text">${Math.round(progress)}% Complete (${completedSubtasks}/${projectSubtasks.length} subtasks)</div>
                    <p style="margin: 10px 0; color: #666;">${project.description || 'No description provided'}</p>
                    <div class="subtask-list">
                        ${projectSubtasks.slice(0, 3).map(subtask => `
                            <div class="subtask-item">
                                <div class="subtask-header">
                                    <span class="subtask-title">${subtask.title}</span>
                                    <span class="subtask-marks">${subtask.marks || 'Pending'}</span>
                                </div>
                                <div class="subtask-description">${subtask.description || 'No description'}</div>
                                <div style="font-size: 11px; color: #666; margin: 5px 0;">
                                    <span>Status: ${subtask.status}</span>
                                    ${subtask.due_date ? ` | Due: ${subtask.due_date}` : ''}
                                </div>
                                ${subtask.feedback ? `<div class="subtask-feedback">${subtask.feedback}</div>` : ''}
                            </div>
                        `).join('')}
                        ${projectSubtasks.length > 3 ? `<div style="text-align: center; font-size: 12px; color: #666; margin-top: 10px;">+${projectSubtasks.length - 3} more subtasks</div>` : ''}
                    </div>
                `;
                dashboardProjects.appendChild(projectCard);
            });
        }

        function updateProjectsPage() {
            const projectsList = document.getElementById('projectsList');
            projectsList.innerHTML = '';

            if (projects.length === 0) {
                projectsList.innerHTML = `
                    <div class="no-data" style="grid-column: 1 / -1; text-align: center; padding: 40px;">
                        <h3>No Projects Assigned</h3>
                        <p>You don't have any projects assigned yet. Contact your faculty to get started!</p>
                    </div>
                `;
                return;
            }

            projects.forEach(project => {
                const projectSubtasks = subtasks.filter(s => s.project_id === project.id);
                const completedSubtasks = projectSubtasks.filter(s => s.status === 'completed').length;
                const progress = projectSubtasks.length > 0 ? (completedSubtasks / projectSubtasks.length) * 100 : 0;

                // Calculate project average score
                const projectMarks = projectSubtasks.filter(s => s.marks !== null);
                const projectAverageScore = projectMarks.length > 0 ? 
                    Math.round((projectMarks.reduce((sum, s) => sum + s.marks, 0) / projectMarks.length) * 10) / 10 : 0;

                const projectCard = document.createElement('div');
                projectCard.className = 'project-card';
                projectCard.innerHTML = `
                    <h3>${project.title}</h3>
                    <div style="margin: 10px 0; font-size: 12px; color: #666;">
                        <strong>Status:</strong> ${project.status} | 
                        <strong>Due:</strong> ${project.due_date || 'Not set'} | 
                        <strong>Score:</strong> ${projectAverageScore}/10
                    </div>
                    <div class="progress-container">
                        <div class="progress-bar" style="width: ${progress}%"></div>
                    </div>
                    <div class="progress-text">${Math.round(progress)}% Complete (${completedSubtasks}/${projectSubtasks.length} subtasks)</div>
                    <p style="margin: 10px 0; color: #666;">${project.description || 'No description provided'}</p>
                    <div class="subtask-list">
                        ${projectSubtasks.map(subtask => `
                            <div class="subtask-item">
                                <div class="subtask-header">
                                    <span class="subtask-title">${subtask.title}</span>
                                    <span class="subtask-marks">${subtask.marks || 'Pending'}</span>
                                </div>
                                <div class="subtask-description">${subtask.description || 'No description'}</div>
                                <div style="font-size: 11px; color: #666; margin: 5px 0;">
                                    <span>Status: ${subtask.status}</span>
                                    ${subtask.due_date ? ` | Due: ${subtask.due_date}` : ''}
                                </div>
                                ${subtask.feedback ? `<div class="subtask-feedback">${subtask.feedback}</div>` : ''}
                            </div>
                        `).join('')}
                    </div>
                    <button class="btn-add-subtask" onclick="openAddSubtaskModal(${project.id})">Add Subtask</button>
                `;
                projectsList.appendChild(projectCard);
            });
        }

        function updateSubtasksPage() {
            const subtasksList = document.getElementById('subtasksList');
            subtasksList.innerHTML = '';

            if (subtasks.length === 0) {
                subtasksList.innerHTML = `
                    <div class="no-data" style="grid-column: 1 / -1; text-align: center; padding: 40px;">
                        <h3>No Subtasks Found</h3>
                        <p>You don't have any subtasks yet. Add some subtasks to your projects to get started!</p>
                    </div>
                `;
                return;
            }

            // Group subtasks by project
            const subtasksByProject = {};
            subtasks.forEach(subtask => {
                if (!subtasksByProject[subtask.project_id]) {
                    subtasksByProject[subtask.project_id] = {
                        project_title: subtask.project_title,
                        subtasks: []
                    };
                }
                subtasksByProject[subtask.project_id].subtasks.push(subtask);
            });

            Object.values(subtasksByProject).forEach(projectData => {
                const projectCard = document.createElement('div');
                projectCard.className = 'project-card';
                projectCard.innerHTML = `
                    <h3>${projectData.project_title}</h3>
                    <div class="subtask-list">
                        ${projectData.subtasks.map(subtask => `
                            <div class="subtask-item">
                                <div class="subtask-header">
                                    <span class="subtask-title">${subtask.title}</span>
                                    <span class="subtask-marks">${subtask.marks || 'Pending'}</span>
                                </div>
                                <div class="subtask-description">${subtask.description || 'No description'}</div>
                                <div style="font-size: 11px; color: #666; margin: 5px 0;">
                                    <span>Status: ${subtask.status}</span>
                                    ${subtask.due_date ? ` | Due: ${subtask.due_date}` : ''}
                                    ${subtask.evaluated_at ? ` | Evaluated: ${new Date(subtask.evaluated_at).toLocaleDateString()}` : ''}
                                </div>
                                ${subtask.feedback ? `<div class="subtask-feedback">${subtask.feedback}</div>` : ''}
                            </div>
                        `).join('')}
                    </div>
                `;
                subtasksList.appendChild(projectCard);
            });
        }

        function updateEvaluationPage() {
            const tableBody = document.getElementById('evaluationTableBody');
            tableBody.innerHTML = '';

            const evaluatedSubtasks = subtasks.filter(s => s.marks !== null);
            
            if (evaluatedSubtasks.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="5" class="no-data">No evaluations yet</td></tr>';
                return;
            }

            evaluatedSubtasks.forEach(subtask => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${subtask.project_title}</td>
                    <td>${subtask.title}</td>
                    <td><strong>${subtask.marks}/10</strong></td>
                    <td><span class="card-status status-${subtask.status}">${subtask.status}</span></td>
                    <td>${subtask.feedback || 'No feedback provided'}</td>
                `;
                tableBody.appendChild(row);
            });
        }

        function setupEventListeners() {
            // Navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', () => {
                    if (item.dataset.page === 'logout') {
                        logout();
                        return;
                    }

                    document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
                    item.classList.add('active');

                    document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
                    document.getElementById(item.dataset.page).classList.add('active');
                });
            });

            // Add subtask modal
            const modal = document.getElementById('addSubtaskModal');
            const closeBtn = document.querySelector('.close');
            const form = document.getElementById('addSubtaskForm');

            closeBtn.onclick = () => modal.style.display = 'none';
            window.onclick = (event) => {
                if (event.target === modal) modal.style.display = 'none';
            };

            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const formData = {
                    project_id: document.getElementById('subtaskProject').value,
                    title: document.getElementById('subtaskTitle').value,
                    description: document.getElementById('subtaskDescription').value,
                    due_date: document.getElementById('subtaskDueDate').value
                };

                try {
                    const response = await fetch('/api/subtask', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(formData)
                    });

                    const result = await response.json();
                    
                    if (response.ok) {
                        alert('Subtask added successfully!');
                        modal.style.display = 'none';
                        form.reset();
                        loadDashboardData(); // Reload data
                    } else {
                        alert('Error adding subtask: ' + (result.message || 'Unknown error'));
                    }
                } catch (error) {
                    console.error('Error adding subtask:', error);
                    alert('Error adding subtask: ' + error.message);
                }
            });
        }

        function openAddSubtaskModal(projectId) {
            const modal = document.getElementById('addSubtaskModal');
            const projectSelect = document.getElementById('subtaskProject');
            
            // Populate project select
            projectSelect.innerHTML = '<option value="">Select a project</option>';
            projects.forEach(project => {
                const option = document.createElement('option');
                option.value = project.id;
                option.textContent = project.title;
                if (project.id === projectId) option.selected = true;
                projectSelect.appendChild(option);
            });

            modal.style.display = 'block';
        }

        function updateProgressTrackingPage() {
            // Update progress summary cards
            const totalProjects = projects.length;
            const completedProjects = projects.filter(p => p.status === 'completed').length;
            
            // Calculate overall progress
            let totalSubtasks = 0;
            let completedSubtasks = 0;
            let totalMarks = 0;
            let evaluatedSubtasks = 0;
            
            projects.forEach(project => {
                const projectSubtasks = subtasks.filter(s => s.project_id === project.id);
                totalSubtasks += projectSubtasks.length;
                completedSubtasks += projectSubtasks.filter(s => s.status === 'completed').length;
                
                projectSubtasks.forEach(subtask => {
                    if (subtask.marks !== null) {
                        totalMarks += subtask.marks;
                        evaluatedSubtasks++;
                    }
                });
            });
            
            const overallProgress = totalSubtasks > 0 ? Math.round((completedSubtasks / totalSubtasks) * 100) : 0;
            const averageScore = evaluatedSubtasks > 0 ? Math.round((totalMarks / evaluatedSubtasks) * 10) / 10 : 0;
            
            document.getElementById('progressTotalProjects').textContent = totalProjects;
            document.getElementById('progressCompletedProjects').textContent = completedProjects;
            document.getElementById('progressOverallPercentage').textContent = overallProgress + '%';
            document.getElementById('progressAverageScore').textContent = averageScore + '/10';
            
            // Update detailed progress cards
            const progressContainer = document.getElementById('progressTrackingProjects');
            progressContainer.innerHTML = '';
            
            if (projects.length === 0) {
                progressContainer.innerHTML = `
                    <div class="no-data" style="grid-column: 1 / -1; text-align: center; padding: 40px;">
                        <h3>No Projects to Track</h3>
                        <p>You don't have any projects assigned yet. Contact your faculty to get started!</p>
                    </div>
                `;
                return;
            }
            
            projects.forEach(project => {
                const projectSubtasks = subtasks.filter(s => s.project_id === project.id);
                const projectCompletedSubtasks = projectSubtasks.filter(s => s.status === 'completed').length;
                const projectProgress = projectSubtasks.length > 0 ? Math.round((projectCompletedSubtasks / projectSubtasks.length) * 100) : 0;
                
                // Calculate project average score
                const projectMarks = projectSubtasks.filter(s => s.marks !== null);
                const projectAverageScore = projectMarks.length > 0 ? 
                    Math.round((projectMarks.reduce((sum, s) => sum + s.marks, 0) / projectMarks.length) * 10) / 10 : 0;
                
                const progressCard = document.createElement('div');
                progressCard.className = 'project-card';
                progressCard.innerHTML = `
                    <h3>${project.title}</h3>
                    <div style="margin: 10px 0; font-size: 12px; color: #666;">
                        <strong>Status:</strong> ${project.status} | 
                        <strong>Due:</strong> ${project.due_date || 'Not set'} | 
                        <strong>Score:</strong> ${projectAverageScore}/10
                    </div>
                    <div class="progress-container">
                        <div class="progress-bar" style="width: ${projectProgress}%"></div>
                    </div>
                    <div class="progress-text">${projectProgress}% Complete (${projectCompletedSubtasks}/${projectSubtasks.length} subtasks)</div>
                    <p style="margin: 10px 0; color: #666;">${project.description || 'No description provided'}</p>
                    <div class="subtask-list">
                        ${projectSubtasks.map(subtask => `
                            <div class="subtask-item">
                                <div class="subtask-header">
                                    <span class="subtask-title">${subtask.title}</span>
                                    <span class="subtask-marks">${subtask.marks || 'Pending'}</span>
                                </div>
                                <div class="subtask-description">${subtask.description || 'No description'}</div>
                                <div style="font-size: 11px; color: #666; margin: 5px 0;">
                                    <span>Status: ${subtask.status}</span>
                                    ${subtask.due_date ? ` | Due: ${subtask.due_date}` : ''}
                                    ${subtask.evaluated_at ? ` | Evaluated: ${new Date(subtask.evaluated_at).toLocaleDateString()}` : ''}
                                </div>
                                ${subtask.feedback ? `<div class="subtask-feedback">${subtask.feedback}</div>` : ''}
                            </div>
                        `).join('')}
                    </div>
                `;
                progressContainer.appendChild(progressCard);
            });
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.removeItem('user');
                window.location.href = 'auth.html';
            }
        }
    </script>
</body>
</html>